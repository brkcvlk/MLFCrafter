name: üè∑Ô∏è Auto-Create Release from Version Bump

on:
  push:
    branches: [main]
    paths: 
      - 'mlfcrafter/__init__.py'
      - 'pyproject.toml'

permissions:
  contents: write

jobs:
  check-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: üõí Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to compare

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üì¶ Install PDM
        run: pip install pdm

      - name: üîç Check if this is a version bump commit
        id: check_version_bump
        run: |
          # Check if commit message contains version bump pattern
          COMMIT_MSG=$(git log -1 --pretty=%s)
          echo "Commit message: $COMMIT_MSG"
          
          if [[ "$COMMIT_MSG" =~ ^üîñ.*bump:.*version.*‚Üí.* ]] || [[ "$COMMIT_MSG" =~ ^bump:.*version.*‚Üí.* ]]; then
            echo "Version bump commit detected!"
            echo "is_version_bump=true" >> $GITHUB_OUTPUT
            
            # Extract version from commit message or get current version
            CURRENT_VERSION=$(pdm show --version)
            echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
            
            # Check if tag already exists
            if git rev-parse "v$CURRENT_VERSION" >/dev/null 2>&1; then
              echo "Tag v$CURRENT_VERSION already exists, skipping release creation"
              echo "tag_exists=true" >> $GITHUB_OUTPUT
            else
              echo "Tag v$CURRENT_VERSION does not exist, will create release"
              echo "tag_exists=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Not a version bump commit, skipping"
            echo "is_version_bump=false" >> $GITHUB_OUTPUT
          fi

      - name: üè∑Ô∏è Create Git Tag and GitHub Release
        if: steps.check_version_bump.outputs.is_version_bump == 'true' && steps.check_version_bump.outputs.tag_exists == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.check_version_bump.outputs.current_version }}"
          
          echo "Creating tag and release for version: $VERSION"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create and push tag
          git tag -a "v$VERSION" -m "üîñ Release v$VERSION"
          git push origin "v$VERSION"
          
          # Get previous version for changelog
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          
          # Create release notes
          if [ -n "$PREVIOUS_TAG" ]; then
            CHANGELOG_LINK="**Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREVIOUS_TAG...v$VERSION"
          else
            CHANGELOG_LINK="**Full Changelog**: https://github.com/${{ github.repository }}/commits/v$VERSION"
          fi
          
          # Create GitHub Release
          gh release create "v$VERSION" \
            --title "üöÄ Release v$VERSION" \
            --notes "## üîñ Release v$VERSION

          This release was automatically created after version bump was merged to main branch.

          ### üì¶ Installation
          \`\`\`bash
          pip install mlfcrafter==$VERSION
          \`\`\`

          ### üöÄ What's New
          Check the commit history and pull requests for detailed changes in this version.

          $CHANGELOG_LINK

          ---
          ü§ñ *This release was created automatically. Detailed release notes will be generated shortly by the release notes workflow.*" \
            --latest

          echo "‚úÖ Release v$VERSION created successfully!"
          echo "üöÄ This will now trigger:"
          echo "   ‚Üí PyPI publishing workflow"
          echo "   ‚Üí Release notes generation workflow"

      - name: ‚ÑπÔ∏è Release Creation Summary
        if: always()
        run: |
          if [[ "${{ steps.check_version_bump.outputs.is_version_bump }}" == "true" ]]; then
            if [[ "${{ steps.check_version_bump.outputs.tag_exists }}" == "true" ]]; then
              echo "‚ÑπÔ∏è Version bump detected but release already exists for v${{ steps.check_version_bump.outputs.current_version }}"
            else
              echo "‚úÖ Version bump detected and release created for v${{ steps.check_version_bump.outputs.current_version }}"
            fi
          else
            echo "‚ÑπÔ∏è No version bump detected in this commit - no release created"
          fi 